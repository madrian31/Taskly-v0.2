import{j as e,F as Pe,d as ne,D as le,T as re,C as G,e as W,P as J,f as Re,g as Le,h as de,i as ce,E as me,k as K,l as Z,m as ee,r as x,S as Ae,n as Be,o as qe}from"./vendor_react-DzLbOw2L.js";/* empty css            */import{d as B,a as ue,S as Oe}from"./index-BAFij-Zg.js";import{c as Ve,q as se,w as q,d as te,e as H,f as X,T as O,h as Ge,u as pe,k as We,m as Qe,r as he,n as He,p as Xe,t as Je}from"./vendor_firebase-IVhDGhNF.js";import"./vendor-DuPUYBON.js";function Ke({isOpen:w,showSuccess:s,onClose:a,onCloseSuccess:i,onSubmit:o,form:l,handleFormChange:u,handleFileSelect:g,removeFile:v,removeAttachment:b,isImageAttachment:p,uploadedFiles:j,attachments:k,uploading:N,editingTaskId:T,isSubtaskMode:f,showValidationErrors:C,fileUploadService:S}){return!w&&!s?null:e.jsxs(e.Fragment,{children:[w&&e.jsx("div",{className:"task-modal-overlay",onClick:a,children:e.jsxs("div",{className:"task-modal",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"task-modal-header",children:[e.jsx("h2",{className:"task-modal-title",children:T?f?"Edit Subtask":"Edit Task":f?"Add New Subtask":"Add New Task"}),e.jsx("button",{className:"task-modal-close-btn",type:"button",onClick:a,"aria-label":"Close modal",children:"×"})]}),e.jsx("div",{className:"task-modal-body",children:e.jsxs("form",{id:"taskForm",onSubmit:o,children:[e.jsxs("div",{className:"task-form-group",children:[e.jsxs("label",{className:"task-form-label",children:[f?"Subtask Name":"Task Name",e.jsx("span",{className:"required-star",children:"*"})]}),e.jsx("input",{type:"text",className:"task-input-field",name:"task_name",id:"taskName",placeholder:f?"Enter subtask name":"Enter task name",value:l.task_name,onChange:u,required:!0}),e.jsx("div",{className:`task-error-message ${C&&!l.task_name?"task-error-visible":""}`,id:"taskNameError",children:f?"Subtask name is required":"Task name is required"})]}),e.jsxs("div",{className:"task-form-group",children:[e.jsx("label",{className:"task-form-label",children:"Description"}),e.jsx("textarea",{className:"task-input-field",id:"taskDescription",name:"description",placeholder:"Add a description (optional)",value:l.description,onChange:u})]}),e.jsxs("div",{className:"task-form-row",children:[e.jsxs("div",{className:"task-form-group",children:[e.jsx("label",{className:"task-form-label",children:"Status"}),e.jsxs("select",{className:"task-input-field",id:"taskStatus",name:"status",value:l.status,onChange:u,children:[e.jsx("option",{value:"todo",children:"Todo"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"done",children:"Done"})]})]}),e.jsxs("div",{className:"task-form-group",children:[e.jsxs("label",{className:"task-form-label task-priority-label-header",children:["Priority",e.jsx("span",{className:"task-info-icon",children:"i"})]}),e.jsxs("select",{className:"task-input-field",id:"taskPriority",name:"priority",value:l.priority,onChange:u,children:[e.jsx("option",{value:1,children:"Low"}),e.jsx("option",{value:2,children:"Medium"}),e.jsx("option",{value:3,children:"High"}),e.jsx("option",{value:4,children:"Urgent"})]})]})]}),e.jsxs("div",{className:"task-form-group",children:[e.jsx("label",{className:"task-form-label",children:"Due Date"}),e.jsx("input",{type:"date",className:"task-input-field",id:"taskDueDate",name:"due_date",value:l.due_date,onChange:u})]}),e.jsxs("div",{className:"task-form-group",children:[e.jsx("label",{className:"task-form-label",children:"Attachments"}),e.jsxs("div",{className:`file-upload-box ${N?"uploading":""}`,children:[e.jsx("input",{type:"file",multiple:!0,onChange:g,className:"file-input-hidden",id:"fileInput",accept:"image/*,.pdf,.doc,.docx,.txt",disabled:N}),e.jsxs("label",{htmlFor:"fileInput",className:`file-upload-label ${N?"uploading":""}`,children:[e.jsx(Pe,{size:24,className:"fileup-icon"}),e.jsx("p",{className:"file-upload-title",children:"Click to upload or drag files"}),e.jsx("p",{className:"file-upload-note",children:"Images, PDF, DOC, TXT (Max 10MB each)"})]})]}),k.length>0&&e.jsxs("div",{className:"attachments-section",children:[e.jsxs("p",{className:"attachments-heading",children:["Current Attachments: ",k.length]}),k.some(r=>p(r))&&e.jsxs("div",{className:"images-grid",children:[e.jsx("p",{className:"images-heading-small",children:"Images:"}),e.jsx("div",{className:"images-grid-grid",children:k.filter(r=>p(r)).map(r=>e.jsxs("div",{className:"attachment-item",children:[e.jsx("img",{src:r.fileUrl,alt:r.fileName,className:"attachment-img"}),e.jsx("button",{type:"button",onClick:()=>b(r.id),className:"attachment-remove-btn",title:`Remove ${r.fileName}`,children:"×"})]},r.id))})]}),k.some(r=>!p(r))&&e.jsxs("div",{children:[e.jsx("p",{className:"attachment-files-heading",children:"Files:"}),e.jsx("div",{className:"attachment-files-list",children:k.filter(r=>!p(r)).map(r=>e.jsxs("div",{className:"attachment-file-row",children:[e.jsxs("div",{className:"attachment-file-meta",children:[e.jsx(ne,{size:18,className:"file-icon-purple"}),e.jsx("span",{className:"attachment-file-name",children:r.fileName})]}),e.jsxs("div",{className:"flex-gap-4",children:[e.jsx("a",{href:r.fileUrl,target:"_blank",rel:"noopener noreferrer",title:"Download file",children:e.jsx(le,{size:16})}),e.jsx("button",{type:"button",onClick:()=>b(r.id),title:"Remove file",className:"icon-button-danger",children:e.jsx(re,{size:16})})]})]},r.id))})]})]}),j.length>0&&e.jsxs("div",{className:"new-files-section",children:[e.jsxs("p",{className:"new-files-heading",children:["New Files to Upload: ",j.length]}),j.some(r=>S.isImageFile(r))&&e.jsxs("div",{className:"images-grid-wrapper",children:[e.jsx("p",{className:"attachment-files-heading",children:"Images:"}),e.jsx("div",{className:"images-grid-grid",children:j.filter(r=>S.isImageFile(r)).map((r,n)=>e.jsxs("div",{className:"attachment-item",children:[e.jsx("img",{src:URL.createObjectURL(r),alt:r.name,className:"attachment-img",title:r.name}),e.jsx("button",{type:"button",onClick:()=>v(j.indexOf(r)),className:"attachment-remove-btn",title:`Remove ${r.name}`,children:"×"})]},n))})]}),j.some(r=>!S.isImageFile(r))&&e.jsxs("div",{children:[e.jsx("p",{className:"attachment-files-heading",children:"Files:"}),e.jsx("div",{className:"attachment-files-list",children:j.filter(r=>!S.isImageFile(r)).map((r,n)=>e.jsxs("div",{className:"attachment-file-row",children:[e.jsxs("div",{className:"attachment-file-meta",children:[e.jsx(ne,{size:18,className:"file-icon-purple"}),e.jsx("span",{className:"attachment-file-name",children:r.name})]}),e.jsxs("div",{className:"flex-gap-4",children:[e.jsx("a",{href:URL.createObjectURL(r),download:r.name,title:"Download file",children:e.jsx(le,{size:16})}),e.jsx("button",{type:"button",onClick:()=>v(n),title:"Remove file",className:"icon-button-danger",children:e.jsx(re,{size:16})})]})]},n))})]})]})]})]})}),e.jsxs("div",{className:"task-modal-footer",children:[e.jsx("button",{type:"button",className:"task-btn task-btn-cancel",onClick:a,disabled:N,children:"Cancel"}),e.jsx("button",{type:"button",className:"task-btn task-btn-primary",onClick:o,disabled:N,children:N?"Uploading...":T?f?"Save Subtask":"Save Task":f?"Add Subtask":"Add Task"})]})]})}),s&&e.jsx("div",{className:"task-modal-overlay",onClick:i,children:e.jsxs("div",{className:"task-modal task-modal--small",onClick:r=>r.stopPropagation(),children:[e.jsx("div",{className:"task-modal-header task-modal-header--compact",children:e.jsx("button",{className:"task-modal-close-btn",type:"button",onClick:i,"aria-label":"Close modal",children:"×"})}),e.jsxs("div",{className:"task-modal-body task-modal-body--success",children:[e.jsx("div",{className:"success-icon-circle",children:e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"#7c3aed",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})}),e.jsx("h2",{className:"success-title",children:"Awesome!"}),e.jsxs("p",{className:"success-message",children:[f?"Subtask":"Task"," successfully added to your list"]}),e.jsx("button",{type:"button",className:"task-btn task-btn-primary task-btn-full",onClick:i,children:"Continue"})]})]})})]})}function Ye(w){const{filteredTasks:s,subtasks:a,loading:i,isMobileView:o,expandedTasks:l,openDropdownId:u,activeFilter:g,toggleTaskExpansion:v,toggleDropdown:b,closeDropdown:p,openModal:j,openEditModal:k,deleteTask:N,toggleTaskCompletion:T,updateTaskStatus:f,formatDueDate:C,getStatusIcon:S,getPriorityInfo:r}=w;return e.jsx("div",{className:"task-list-container",children:i?e.jsxs("div",{className:"loading-state",children:[e.jsx(G,{className:"animate-spin",size:24}),e.jsx("p",{children:"Loading tasks..."})]}):s.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx(W,{size:48,className:"text-slate-300"}),e.jsx("h3",{children:"No tasks found"}),e.jsx("p",{children:"Get started by creating your first task!"}),e.jsxs("button",{className:"empty-state-button",onClick:()=>j(),children:[e.jsx(J,{size:20}),"Create Task"]})]}):e.jsx("div",{className:"tasks-list",children:s.map(n=>{const _=n.id?a[n.id]||[]:[],P=g==="all"?_:_.filter(m=>m.status===g),E=_.filter(m=>m.status==="done").length,F=P.length>0,y=n.id?l.has(n.id):!1,M=S(n.status),R=r(n.priority),$=M.icon;return e.jsxs("div",{className:"task-row-container",children:[e.jsxs("div",{className:"task-row",children:[e.jsx("button",{className:"expand-button",onClick:()=>n.id&&F&&v(n.id),disabled:!F,children:F?y?e.jsx(Re,{size:16,className:"text-slate-500"}):e.jsx(Le,{size:16,className:"text-slate-500"}):e.jsx("div",{className:"w-4 h-4"})}),e.jsxs("div",{className:"task-content",children:[e.jsx("div",{className:"task-title-row",children:e.jsxs("h3",{className:"task-title",children:[n.task_name,n.id&&_.length>0&&e.jsxs("span",{className:"subtask-pill","aria-label":`${E} of ${_.length} subtasks completed`,children:[E,"/",_.length]})]})}),n.description&&e.jsx("p",{className:"task-description",children:n.description})]}),e.jsxs("div",{className:"status-badge",children:[e.jsx($,{size:16,className:M.color}),e.jsx("span",{className:"status-text",children:n.status.replace("_"," ")})]}),e.jsxs("div",{className:"priority-badge",children:[e.jsx(de,{size:16,className:R.color}),e.jsx("span",{className:`priority-text ${R.color}`,children:R.text})]}),e.jsxs("div",{className:"due-date",children:[e.jsx(ce,{size:16,className:"text-slate-500"}),e.jsx("span",{className:"due-date-text",children:C(n.due_date)})]}),e.jsx("div",{className:"task-actions-dropdown",children:e.jsxs("div",{className:"relative-position",children:[e.jsx("button",{className:"more-actions-button",onClick:m=>{m.stopPropagation(),n.id&&b(n.id)},"aria-expanded":u===n.id,children:e.jsx(me,{size:16,className:"text-slate-500"})}),u===n.id&&(o?e.jsxs("div",{children:[e.jsx("div",{className:"mobile-sheet-backdrop",onClick:p}),e.jsxs("div",{className:"mobile-sheet",role:"dialog","aria-modal":"true",onClick:m=>m.stopPropagation(),children:[e.jsx("div",{className:"mobile-sheet-header",children:e.jsx("button",{className:"mobile-sheet-close",onClick:p,"aria-label":"Close",children:"×"})}),e.jsxs("div",{className:"mobile-sheet-content",children:[e.jsx("div",{className:"dropdown-section-title",children:"Change Status"}),n.status!=="todo"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),n.id&&f(n.id,"todo")},children:[e.jsx(W,{size:16,className:"text-slate-400"}),e.jsx("span",{children:"Mark as To Do"})]}),n.status!=="in_progress"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),n.id&&f(n.id,"in_progress")},children:[e.jsx(G,{size:16,className:"text-blue-500"}),e.jsx("span",{children:"Mark as In Progress"})]}),n.status!=="done"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),n.id&&f(n.id,"done")},children:[e.jsx(K,{size:16,className:"text-emerald-500"}),e.jsx("span",{children:"Mark as Done"})]}),e.jsx("div",{className:"dropdown-divider"}),(n.parent_id===null||n.parent_id===void 0)&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),n.id&&j(n.id)},children:[e.jsx(J,{size:16}),e.jsx("span",{children:"Add Subtask"})]}),e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),k(n)},children:[e.jsx(Z,{size:16}),e.jsx("span",{children:"Edit Task"})]}),e.jsxs("div",{className:"dropdown-item delete",onClick:()=>{p(),n.id&&N(n.id)},children:[e.jsx(ee,{size:16}),e.jsx("span",{children:"Delete Task"})]})]})]})]}):e.jsxs("div",{className:"dropdown-menu",onClick:m=>m.stopPropagation(),children:[e.jsx("div",{className:"dropdown-section-title",children:"Change Status"}),n.status!=="todo"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),n.id&&f(n.id,"todo")},children:[e.jsx(W,{size:14,className:"text-slate-400"}),e.jsx("span",{children:"Mark as To Do"})]}),n.status!=="in_progress"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),n.id&&f(n.id,"in_progress")},children:[e.jsx(G,{size:14,className:"text-blue-500"}),e.jsx("span",{children:"Mark as In Progress"})]}),n.status!=="done"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),n.id&&f(n.id,"done")},children:[e.jsx(K,{size:14,className:"text-emerald-500"}),e.jsx("span",{children:"Mark as Done"})]}),e.jsx("div",{className:"dropdown-divider"}),(n.parent_id===null||n.parent_id===void 0)&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),n.id&&j(n.id)},children:[e.jsx(J,{size:14}),e.jsx("span",{children:"Add Subtask"})]}),e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),k(n)},children:[e.jsx(Z,{size:14}),e.jsx("span",{children:"Edit Task"})]}),e.jsxs("div",{className:"dropdown-item delete",onClick:()=>{p(),n.id&&N(n.id)},children:[e.jsx(ee,{size:14}),e.jsx("span",{children:"Delete Task"})]})]}))]})})]}),F&&y&&e.jsxs("div",{className:"subtasks-container",children:[e.jsx("div",{className:"connector-line"}),P.map(m=>{const U=S(m.status),z=r(m.priority),D=U.icon;return e.jsxs("div",{className:"subtask-row",children:[e.jsx("div",{className:"horizontal-connector"}),e.jsxs("div",{className:"subtask-card",children:[e.jsx("div",{className:"expand-button-placeholder"}),e.jsxs("div",{className:"task-content",children:[e.jsx("div",{className:"task-title-row",children:e.jsx("h4",{className:"subtask-title",children:m.task_name})}),m.description&&e.jsx("p",{className:"task-description",children:m.description})]}),e.jsxs("div",{className:"status-badge",children:[e.jsx(D,{size:16,className:U.color}),e.jsx("span",{className:"status-text",children:m.status.replace("_"," ")})]}),e.jsxs("div",{className:"priority-badge",children:[e.jsx(de,{size:16,className:z.color}),e.jsx("span",{className:`priority-text ${z.color}`,children:z.text})]}),e.jsxs("div",{className:"due-date",children:[e.jsx(ce,{size:16,className:"text-slate-500"}),e.jsx("span",{className:"due-date-text",children:C(m.due_date)})]}),e.jsx("div",{className:"task-actions-dropdown",children:e.jsxs("div",{className:"relative-position",children:[e.jsx("button",{className:"more-actions-button",onClick:L=>{L.stopPropagation(),m.id&&b(m.id)},"aria-expanded":u===m.id,children:e.jsx(me,{size:16,className:"text-slate-500"})}),u===m.id&&e.jsxs("div",{className:"dropdown-menu",onClick:L=>L.stopPropagation(),children:[e.jsx("div",{className:"dropdown-section-title",children:"Change Status"}),m.status!=="todo"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),m.id&&f(m.id,"todo")},children:[e.jsx(W,{size:14,className:"text-slate-400"}),e.jsx("span",{children:"Mark as To Do"})]}),m.status!=="in_progress"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),m.id&&f(m.id,"in_progress")},children:[e.jsx(G,{size:14,className:"text-blue-500"}),e.jsx("span",{children:"Mark as In Progress"})]}),m.status!=="done"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),m.id&&f(m.id,"done")},children:[e.jsx(K,{size:14,className:"text-emerald-500"}),e.jsx("span",{children:"Mark as Done"})]}),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("div",{className:"dropdown-item",onClick:()=>{p(),k(m)},children:[e.jsx(Z,{size:14}),e.jsx("span",{children:"Edit Task"})]}),e.jsxs("div",{className:"dropdown-item delete",onClick:()=>{p(),m.id&&N(m.id)},children:[e.jsx(ee,{size:14}),e.jsx("span",{children:"Delete Task"})]})]})]})})]})]},m.id)})]})]},n.id)})})})}class Ze{constructor(){this.ref=Ve(B,"tasks")}getCurrentUid(){return ue.currentUser?ue.currentUser.uid:null}async getAllTasks(){const s=this.getCurrentUid();if(!s)return[];const a=se(this.ref,q("owner_uid","==",s));return(await te(a)).docs.map(o=>({id:o.id,...o.data()}))}async getMainTasks(){const s=this.getCurrentUid();if(!s)return[];const a=se(this.ref,q("owner_uid","==",s),q("parent_id","==",null));return(await te(a)).docs.map(l=>({id:l.id,...l.data()}))}async getSubTasks(s){const a=this.getCurrentUid();if(!a)return[];const i=se(this.ref,q("owner_uid","==",a),q("parent_id","==",s));return(await te(i)).docs.map(l=>({id:l.id,...l.data()}))}async getTaskById(s){const a=H(B,"tasks",s),i=await X(a);if(!i.exists())return null;const o=i.data(),l=this.getCurrentUid();return!l||o.owner_uid&&o.owner_uid!==l?null:{id:i.id,...o}}async createTask(s){if(s.priority<1||s.priority>4)throw new Error("Priority must be between 1 and 4");const a=O.now(),i=this.getCurrentUid();if(!i)throw new Error("Not authenticated");await Ge(this.ref,{task_name:s.task_name,description:s.description??null,parent_id:s.parent_id??null,status:s.status??"todo",priority:s.priority,due_date:s.due_date?O.fromDate(s.due_date):null,attachments:s.attachments??null,created_at:a,updated_at:a,completed_at:s.status==="done"?a:null,owner_uid:i})}async updateStatus(s,a){if(!["todo","in_progress","blocked","done"].includes(a))throw new Error("Invalid status value");const i=O.now(),o=H(B,"tasks",s),l=await X(o),u=this.getCurrentUid();if(!u)throw new Error("Not authenticated");const g=l.exists()?l.data():null;if(!g||g.owner_uid&&g.owner_uid!==u)throw new Error("Unauthorized");await pe(o,{status:a,updated_at:i,completed_at:a==="done"?i:null})}async updateTask(s,a){const i=O.now(),o=H(B,"tasks",s),l={...a,updated_at:i};a.due_date&&(l.due_date=O.fromDate(a.due_date)),Object.keys(l).forEach(b=>{l[b]===void 0&&delete l[b]});const u=await X(o),g=this.getCurrentUid();if(!g)throw new Error("Not authenticated");const v=u.exists()?u.data():null;if(!v||v.owner_uid&&v.owner_uid!==g)throw new Error("Unauthorized");await pe(o,l)}async deleteTask(s){const a=H(B,"tasks",s),i=await X(a),o=this.getCurrentUid();if(!o)throw new Error("Not authenticated");const l=i.exists()?i.data():null;if(!l||l.owner_uid&&l.owner_uid!==o)throw new Error("Unauthorized");await We(a)}}class es{constructor(s,a){this.taskRepository=s,this.fileUploadService=a}async completeTask(s){await this.taskRepository.updateStatus(s,"done")}async reopenTask(s){await this.taskRepository.updateStatus(s,"todo")}async updateStatus(s,a){await this.taskRepository.updateStatus(s,a)}async deleteTask(s){try{const a=await this.taskRepository.getTaskById(s);if(a&&a.attachments&&this.fileUploadService)for(const i of a.attachments)try{await this.fileUploadService.deleteFile(i.fileUrl)}catch(o){console.error("Failed to delete attachment for task:",i.fileUrl,o)}try{const i=await this.taskRepository.getSubTasks(s);for(const o of i){if(o&&o.attachments&&this.fileUploadService)for(const l of o.attachments)try{await this.fileUploadService.deleteFile(l.fileUrl)}catch(u){console.error("Failed to delete attachment for subtask:",l.fileUrl,u)}if(o.id)try{await this.taskRepository.deleteTask(o.id)}catch(l){console.error("Failed to delete subtask doc:",o.id,l)}}}catch(i){console.error("Failed to fetch subtasks for deletion:",i)}await this.taskRepository.deleteTask(s)}catch(a){throw console.error("Error deleting task:",a),a}}async uploadTaskFiles(s){if(!this.fileUploadService)throw new Error("FileUploadService is not configured");try{console.log(`[TaskService] Starting file upload for ${s.length} file(s)`);const a=await this.fileUploadService.uploadMultipleFiles(s);return console.log(`[TaskService] File upload successful, got ${a.length} results`),a.map((i,o)=>({id:`attachment_${Date.now()}_${o}`,fileName:i.fileName,fileUrl:i.fileUrl,fileType:i.fileType,uploadedAt:i.uploadedAt}))}catch(a){throw console.error("Error uploading task files:",a),a}}async removeTaskAttachment(s,a,i){try{this.fileUploadService&&await this.fileUploadService.deleteFile(i.fileUrl);const o=await this.taskRepository.getTaskById(s);if(!o)throw new Error("Task not found");const l=o.attachments?.filter(u=>u.id!==a);await this.taskRepository.updateTask(s,{attachments:l})}catch(o){throw console.error("Error removing task attachment:",o),o}}isImageFile(s){if(!this.fileUploadService){const a=["jpg","jpeg","png","gif","webp"],i=s.name.split(".").pop()?.toLowerCase()||"";return s.type.startsWith("image/")||a.includes(i)}return this.fileUploadService.isImageFile(s)}}class ss{constructor(){this.storage=Qe(),this.allowedImageMimeTypes=["image/jpeg","image/jpg","image/png","image/gif","image/webp","image/svg+xml","image/bmp","image/x-icon","image/tiff","image/avif"],this.imageExtensions=["jpg","jpeg","png","gif","webp","svg","bmp","ico","tiff","tif","avif"],this.blockedExtensions=["exe","bat","cmd","com","pif","scr","vbs","js","jar","zip","rar","7z"],this.blockedMimeTypes=["application/x-msdownload","application/x-msdos-program","application/x-executable"],this.maxImageSize=5*1024*1024,this.maxAttachmentSize=25*1024*1024,this.maxTotalUploadSize=100*1024*1024}validateFileType(s){const i=s.name.toLowerCase().split(".").pop()||"",o=s.type.toLowerCase();return this.blockedExtensions.includes(i)?{fileName:s.name,reason:`File type "${i}" is not allowed for security reasons`}:this.blockedMimeTypes.some(l=>o.includes(l))?{fileName:s.name,reason:`File MIME type "${o}" is not allowed for security reasons`}:i?null:{fileName:s.name,reason:"File must have a valid extension"}}isImageFile(s){const a=s.type.toLowerCase(),o=s.name.toLowerCase().split(".").pop()||"";return this.allowedImageMimeTypes.includes(a)?!0:this.imageExtensions.includes(o)}getUploadPath(s){return this.isImageFile(s)?"images":"files"}validateFile(s,a=!1){const i=this.validateFileType(s);if(i)return i;const o=a?this.maxImageSize:this.maxAttachmentSize;if(s.size===0)return{fileName:s.name,reason:"File is empty"};if(s.size>o){const l=a?5:25;return{fileName:s.name,reason:`File exceeds ${l}MB size limit (${(s.size/1024/1024).toFixed(2)}MB)`}}return null}validateFilesBatch(s){const a=[];let i=0;for(const o of s){const l=this.isImageFile(o),u=this.validateFile(o,l);u&&a.push(u),i+=o.size}return i>this.maxTotalUploadSize&&a.push({fileName:"Multiple files",reason:`Total upload size exceeds 100MB limit (${(i/1024/1024).toFixed(2)}MB)`}),a}generateUniqueFileName(s){const a=Date.now(),i=Math.random().toString(36).substring(2,9),o=s.name.split(".").pop()||"";return`${(s.name.substring(0,s.name.lastIndexOf("."))||s.name).replace(/[^a-z0-9_-]/gi,"").substring(0,30)}_${a}_${i}.${o}`}async uploadFile(s){try{const a=this.isImageFile(s);console.log(`[FileUploadService] Uploading: ${s.name} (${a?"Image":"File"}) - Size: ${(s.size/1024/1024).toFixed(2)}MB`);const i=this.validateFile(s,a);if(i)throw console.error(`[FileUploadService] Validation failed for ${s.name}: ${i.reason}`),new Error(i.reason);const o=this.getUploadPath(s),l=this.generateUniqueFileName(s),u=`attachements/${o}/${l}`;console.log(`[FileUploadService] Storage path: ${u}`);const g=he(this.storage,u);console.log("[FileUploadService] Starting upload to Firebase..."),await He(g,s),console.log(`[FileUploadService] Upload complete for ${s.name}`),console.log("[FileUploadService] Getting download URL...");const v=await Xe(g);return console.log("[FileUploadService] Got download URL"),{fileName:s.name,fileUrl:v,fileType:s.type,uploadPath:o,uploadedAt:new Date}}catch(a){throw console.error("Error uploading file:",a),new Error(`Failed to upload ${s.name}: ${a.message}`)}}async uploadMultipleFiles(s){try{console.log(`[FileUploadService] Starting batch upload of ${s.length} file(s)`);const a=this.validateFilesBatch(s);if(a.length>0){const o=a.map(l=>`${l.fileName}: ${l.reason}`).join(`
`);throw console.error(`[FileUploadService] Validation errors: ${o}`),new Error(`File validation failed:
${o}`)}const i=[];for(const o of s){const l=await this.uploadFile(o);i.push(l)}return console.log(`[FileUploadService] Batch upload complete: ${i.length} file(s) uploaded`),i}catch(a){throw console.error("Error uploading multiple files:",a),a}}async deleteFile(s){try{const a=s.split("/o/")[1];if(!a)throw new Error("Invalid file URL");const i=decodeURIComponent(a.split("?")[0]),o=he(this.storage,i);await Je(o)}catch(a){throw console.error("Error deleting file:",a),new Error(`Failed to delete file: ${a.message}`)}}}const I=new Ze,xe=new ss,V=new es(I,xe);function ls(){const[w,s]=x.useState([]),[a,i]=x.useState({}),[o,l]=x.useState(!0),[u,g]=x.useState(!1),[v,b]=x.useState(!1),[p,j]=x.useState(!1),[k,N]=x.useState(null),[T,f]=x.useState("all"),[C,S]=x.useState(""),[r,n]=x.useState(new Set),[_,P]=x.useState(null),[E,F]=x.useState(null),[y,M]=x.useState({task_name:"",description:"",priority:3,status:"todo",due_date:""}),[R,$]=x.useState(!1),[m,U]=x.useState([]),[z,D]=x.useState([]),[L,Q]=x.useState(!1),[fe,ge]=x.useState(!1),je=x.useMemo(()=>{const t={all:w.length,todo:0,in_progress:0,done:0};for(const c of w){const d=c.id?a[c.id]||[]:[];d.some(h=>h.status==="todo")&&(t.todo+=1),d.some(h=>h.status==="in_progress")&&(t.in_progress+=1),d.some(h=>h.status==="done")&&(t.done+=1)}return t},[w,a]);x.useEffect(()=>{A()},[]),x.useEffect(()=>{const t=()=>ge(window.innerWidth<=490);return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);async function A(){try{l(!0),console.log("Loading tasks from Firestore...");const t=await I.getMainTasks();console.log("Main tasks loaded:",t),s(t);const c={};for(const d of t)if(d.id){const h=await I.getSubTasks(d.id);c[d.id]=h}i(c)}catch(t){console.error("Error loading tasks:",t),alert("Error loading tasks: "+t.message)}finally{l(!1)}}async function Ne(t,c=!1){try{const d=c?Object.values(a).flat().find(Y=>Y.id===t):w.find(Y=>Y.id===t);if(!d)return;const h=d.status==="done"?"todo":"done";h==="done"?await V.completeTask(t):await I.updateStatus(t,h),await A()}catch(d){console.error("Error updating task:",d),alert("Error updating task: "+d.message)}}async function we(t,c){try{await V.updateStatus(t,c),await A()}catch(d){console.error("Error updating task status:",d),alert("Error updating task status: "+d.message)}}async function ke(t){try{await V.deleteTask(t),await A()}catch(c){console.error("Error deleting task:",c),alert("Error deleting task: "+c.message)}}function ae(t){M({task_name:"",description:"",priority:3,status:"todo",due_date:""}),$(!1),F(null),U([]),D([]),t?(j(!0),N(t)):(j(!1),N(null)),g(!0)}function ie(){g(!1),$(!1),j(!1),N(null),F(null),U([]),D([])}function ve(t){M({task_name:t.task_name||"",description:t.description||"",priority:t.priority||2,status:t.status||"todo",due_date:t.due_date?t.due_date.seconds?new Date(t.due_date.seconds*1e3).toISOString().slice(0,10):new Date(t.due_date).toISOString().slice(0,10):""}),F(t.id||null),j(t.parent_id!==null&&t.parent_id!==void 0),N(t.parent_id??null),D(t.attachments||[]),U([]),g(!0)}function ye(){b(!1)}function be(t){const{name:c,value:d}=t.target;M(h=>({...h,[c]:d}))}function Se(t){const c=t.target.files;if(c){const d=Array.from(c);U(h=>[...h,...d])}}function Te(t){U(c=>c.filter((d,h)=>h!==t))}async function Ce(t){const c=z.find(d=>d.id===t);if(E&&c)try{Q(!0),await V.removeTaskAttachment(E,t,c),D(d=>d.filter(h=>h.id!==t))}catch(d){console.error("Error removing attachment:",d),alert("Failed to remove attachment: "+d.message)}finally{Q(!1)}else D(d=>d.filter(h=>h.id!==t))}function _e(t){return["image/jpeg","image/png","image/gif","image/webp","image/svg+xml"].includes(t.fileType.toLowerCase())}function Ee(t){n(c=>{const d=new Set(c);return d.has(t)?d.delete(t):d.add(t),d})}function Fe(t){P(c=>c===t?null:t)}function oe(){P(null)}x.useEffect(()=>{function t(){oe()}return document.addEventListener("click",t),()=>document.removeEventListener("click",t)},[]);function Ue(){let t=w;if(T!=="all"&&(t=t.filter(c=>(c.id?a[c.id]||[]:[]).some(h=>h.status===T))),C.trim()){const c=C.toLowerCase();t=t.filter(d=>d.task_name.toLowerCase().includes(c)||d.description&&d.description.toLowerCase().includes(c))}return t}function ze(t){switch(t){case"todo":return{icon:W,color:"text-slate-400"};case"in_progress":return{icon:G,color:"text-blue-500"};case"done":return{icon:K,color:"text-emerald-500"};default:return{icon:qe,color:"text-red-500"}}}function De(t){switch(t){case 1:return{color:"text-slate-400",text:"P4"};case 2:return{color:"text-blue-500",text:"P3"};case 3:return{color:"text-orange-500",text:"P2"};case 4:return{color:"text-red-500",text:"P1"};default:return{color:"text-slate-400",text:"P4"}}}function Me(t){if(!t)return"No date";const c=t;return(c.seconds?new Date(c.seconds*1e3):new Date(t)).toLocaleDateString("en-US",{month:"short",day:"numeric"})}async function $e(t){if(t&&t.preventDefault&&t.preventDefault(),$(!0),!(!y.task_name||y.task_name.trim()===""))try{Q(!0);let c=[...z];if(m.length>0){console.log(`[task.tsx] Uploading ${m.length} new file(s)`);const h=await V.uploadTaskFiles(m);console.log(`[task.tsx] Got ${h.length} attachment(s) with URLs`),c=[...z,...h]}const d={task_name:y.task_name.trim(),description:y.description.trim()||void 0,status:y.status,priority:Number(y.priority),due_date:y.due_date?new Date(y.due_date):void 0,parent_id:p&&k?k:void 0,attachments:c.length>0?c:void 0};console.log("Submitting task:",d),console.log(`[task.tsx] Task has ${c.length} attachment(s)`),E?(await I.updateTask(E,d),console.log("Task updated successfully!")):(await I.createTask(d),console.log("Task created successfully!")),await A(),console.log("Tasks reloaded"),$(!1),ie(),b(!0)}catch(c){console.error("Error adding task from modal:",c),alert("Failed to add task: "+c.message+`

Check console for details.`)}finally{Q(!1)}}const Ie=Ue();return e.jsxs(Oe,{id:"task",children:[e.jsxs("div",{className:"task-header-section",children:[e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("h1",{className:"header-title",children:"Tasks"}),e.jsx("p",{className:"header-subtitle",children:"Manage your tasks effectively with Taskly"})]}),e.jsxs("div",{className:"header-right",children:[e.jsxs("div",{className:"search-container",children:[e.jsx(Ae,{className:"search-icon",size:20}),e.jsx("input",{type:"text",placeholder:"Search tasks...",className:"search-input",value:C,onChange:t=>S(t.target.value)})]}),e.jsx("button",{className:"filter-button",children:e.jsx(Be,{size:20})}),e.jsxs("button",{className:"new-task-button",onClick:()=>ae(),children:[e.jsx(J,{size:20}),"New Task"]})]})]}),e.jsx("div",{className:"filter-tabs",children:[{key:"all",label:"All Tasks"},{key:"todo",label:"To Do"},{key:"in_progress",label:"In Progress"},{key:"done",label:"Done"}].map(t=>e.jsxs("button",{className:`filter-tab ${T===t.key?"active":""}`,onClick:()=>f(t.key),children:[t.label," ","("+(je[t.key]??0)+")"]},t.key))})]}),e.jsx(Ye,{filteredTasks:Ie,subtasks:a,loading:o,isMobileView:fe,expandedTasks:r,openDropdownId:_,activeFilter:T,toggleTaskExpansion:Ee,toggleDropdown:Fe,closeDropdown:oe,openModal:ae,openEditModal:ve,deleteTask:ke,toggleTaskCompletion:Ne,updateTaskStatus:we,formatDueDate:Me,getStatusIcon:ze,getPriorityInfo:De}),e.jsx(Ke,{isOpen:u,showSuccess:v,onClose:ie,onCloseSuccess:ye,onSubmit:$e,form:y,handleFormChange:be,handleFileSelect:Se,removeFile:Te,removeAttachment:Ce,isImageAttachment:_e,uploadedFiles:m,attachments:z,uploading:L,editingTaskId:E,isSubtaskMode:p,showValidationErrors:R,fileUploadService:xe})]})}export{ls as default};
