import{j as e,F as He,d as de,D as me,T as ue,C as G,e as W,P as Z,f as Qe,g as Xe,h as pe,i as he,E as xe,k as ee,l as te,m as ae,n as Ye,r as f,S as Je,o as Ke}from"./vendor_react-785NH7CZ.js";/* empty css            */import{d as O,a as fe,S as Ze}from"./index-CpAHNwlp.js";import{c as es,q as ie,w as B,d as oe,e as J,f as K,T as q,h as ss,u as je,k as ts,m as as,r as ge,n as is,p as os,t as ns}from"./vendor_firebase-BpY39YGu.js";import"./vendor-DhMbaX6P.js";function ls({isOpen:j,showSuccess:s,onClose:t,onCloseSuccess:i,onSubmit:o,form:l,handleFormChange:h,handleFileSelect:p,removeFile:w,removeAttachment:b,isImageAttachment:u,uploadedFiles:N,attachments:y,uploading:v,editingTaskId:F,isSubtaskMode:g,showValidationErrors:T,fileUploadService:_,difficultyEmoji:P,completionMood:R,onDifficultyChange:n,onMoodChange:C}){return!j&&!s?null:e.jsxs(e.Fragment,{children:[j&&e.jsx("div",{className:"task-modal-overlay",onClick:t,children:e.jsxs("div",{className:"task-modal",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"task-modal-header",children:[e.jsx("h2",{className:"task-modal-title",children:F?g?"Edit Subtask":"Edit Task":g?"Add New Subtask":"Add New Task"}),e.jsx("button",{className:"task-modal-close-btn",type:"button",onClick:t,"aria-label":"Close modal",children:"Ã—"})]}),e.jsx("div",{className:"task-modal-body",children:e.jsxs("form",{id:"taskForm",onSubmit:o,children:[e.jsxs("div",{className:"task-form-group",children:[e.jsxs("label",{className:"task-form-label",children:[g?"Subtask Name":"Task Name",e.jsx("span",{className:"required-star",children:"*"})]}),e.jsx("input",{type:"text",className:"task-input-field",name:"task_name",id:"taskName",placeholder:g?"Enter subtask name":"Enter task name",value:l.task_name,onChange:h,required:!0}),e.jsx("div",{className:`task-error-message ${T&&!l.task_name?"task-error-visible":""}`,id:"taskNameError",children:g?"Subtask name is required":"Task name is required"})]}),e.jsxs("div",{className:"task-form-group",children:[e.jsx("label",{className:"task-form-label",children:"Description"}),e.jsx("textarea",{className:"task-input-field",id:"taskDescription",name:"description",placeholder:"Add a description (optional)",value:l.description,onChange:h})]}),e.jsxs("div",{className:"task-form-row",children:[e.jsxs("div",{className:"task-form-group",children:[e.jsx("label",{className:"task-form-label",children:"Status"}),e.jsxs("select",{className:"task-input-field",id:"taskStatus",name:"status",value:l.status,onChange:h,children:[e.jsx("option",{value:"todo",children:"Todo"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"done",children:"Done"})]})]}),e.jsxs("div",{className:"task-form-group",children:[e.jsxs("label",{className:"task-form-label task-priority-label-header",children:["Priority",e.jsx("span",{className:"task-info-icon",children:"i"})]}),e.jsxs("select",{className:"task-input-field",id:"taskPriority",name:"priority",value:l.priority,onChange:h,children:[e.jsx("option",{value:1,children:"Low"}),e.jsx("option",{value:2,children:"Medium"}),e.jsx("option",{value:3,children:"High"}),e.jsx("option",{value:4,children:"Urgent"})]})]})]}),e.jsxs("div",{className:"task-form-group",children:[e.jsx("label",{className:"task-form-label",children:"Due Date"}),e.jsx("input",{type:"date",className:"task-input-field",id:"taskDueDate",name:"due_date",value:l.due_date,onChange:h})]}),e.jsxs("div",{className:"task-form-group",children:[e.jsx("label",{className:"task-form-label",children:"Attachments"}),e.jsxs("div",{className:`file-upload-box ${v?"uploading":""}`,children:[e.jsx("input",{type:"file",multiple:!0,onChange:p,className:"file-input-hidden",id:"fileInput",accept:"image/*,.pdf,.doc,.docx,.txt",disabled:v}),e.jsxs("label",{htmlFor:"fileInput",className:`file-upload-label ${v?"uploading":""}`,children:[e.jsx(He,{size:24,className:"fileup-icon"}),e.jsx("p",{className:"file-upload-title",children:"Click to upload or drag files"}),e.jsx("p",{className:"file-upload-note",children:"Images, PDF, DOC, TXT (Max 10MB each)"})]})]}),y.length>0&&e.jsxs("div",{className:"attachments-section",children:[e.jsxs("p",{className:"attachments-heading",children:["Current Attachments: ",y.length]}),y.some(r=>u(r))&&e.jsxs("div",{className:"images-grid",children:[e.jsx("p",{className:"images-heading-small",children:"Images:"}),e.jsx("div",{className:"images-grid-grid",children:y.filter(r=>u(r)).map(r=>e.jsxs("div",{className:"attachment-item",children:[e.jsx("img",{src:r.fileUrl,alt:r.fileName,className:"attachment-img"}),e.jsx("button",{type:"button",onClick:()=>b(r.id),className:"attachment-remove-btn",title:`Remove ${r.fileName}`,children:"Ã—"})]},r.id))})]}),y.some(r=>!u(r))&&e.jsxs("div",{children:[e.jsx("p",{className:"attachment-files-heading",children:"Files:"}),e.jsx("div",{className:"attachment-files-list",children:y.filter(r=>!u(r)).map(r=>e.jsxs("div",{className:"attachment-file-row",children:[e.jsxs("div",{className:"attachment-file-meta",children:[e.jsx(de,{size:18,className:"file-icon-purple"}),e.jsx("span",{className:"attachment-file-name",children:r.fileName})]}),e.jsxs("div",{className:"flex-gap-4",children:[e.jsx("a",{href:r.fileUrl,target:"_blank",rel:"noopener noreferrer",title:"Download file",children:e.jsx(me,{size:16})}),e.jsx("button",{type:"button",onClick:()=>b(r.id),title:"Remove file",className:"icon-button-danger",children:e.jsx(ue,{size:16})})]})]},r.id))})]})]}),N.length>0&&e.jsxs("div",{className:"new-files-section",children:[e.jsxs("p",{className:"new-files-heading",children:["New Files to Upload: ",N.length]}),N.some(r=>_.isImageFile(r))&&e.jsxs("div",{className:"images-grid-wrapper",children:[e.jsx("p",{className:"attachment-files-heading",children:"Images:"}),e.jsx("div",{className:"images-grid-grid",children:N.filter(r=>_.isImageFile(r)).map((r,S)=>e.jsxs("div",{className:"attachment-item",children:[e.jsx("img",{src:URL.createObjectURL(r),alt:r.name,className:"attachment-img",title:r.name}),e.jsx("button",{type:"button",onClick:()=>w(N.indexOf(r)),className:"attachment-remove-btn",title:`Remove ${r.name}`,children:"Ã—"})]},S))})]}),N.some(r=>!_.isImageFile(r))&&e.jsxs("div",{children:[e.jsx("p",{className:"attachment-files-heading",children:"Files:"}),e.jsx("div",{className:"attachment-files-list",children:N.filter(r=>!_.isImageFile(r)).map((r,S)=>e.jsxs("div",{className:"attachment-file-row",children:[e.jsxs("div",{className:"attachment-file-meta",children:[e.jsx(de,{size:18,className:"file-icon-purple"}),e.jsx("span",{className:"attachment-file-name",children:r.name})]}),e.jsxs("div",{className:"flex-gap-4",children:[e.jsx("a",{href:URL.createObjectURL(r),download:r.name,title:"Download file",children:e.jsx(me,{size:16})}),e.jsx("button",{type:"button",onClick:()=>w(S),title:"Remove file",className:"icon-button-danger",children:e.jsx(ue,{size:16})})]})]},S))})]})]})]})]})}),e.jsxs("div",{className:"task-modal-footer",children:[e.jsx("button",{type:"button",className:"task-btn task-btn-cancel",onClick:t,disabled:v,children:"Cancel"}),e.jsx("button",{type:"button",className:"task-btn task-btn-primary",onClick:o,disabled:v,children:v?"Uploading...":F?g?"Save Subtask":"Save Task":g?"Add Subtask":"Add Task"})]})]})}),s&&e.jsx("div",{className:"task-modal-overlay",onClick:i,children:e.jsxs("div",{className:"task-modal task-modal--small",onClick:r=>r.stopPropagation(),children:[e.jsx("div",{className:"task-modal-header task-modal-header--compact",children:e.jsx("button",{className:"task-modal-close-btn",type:"button",onClick:i,"aria-label":"Close modal",children:"Ã—"})}),e.jsxs("div",{className:"task-modal-body task-modal-body--success",children:[e.jsx("div",{className:"success-icon-circle",children:e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"#7c3aed",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})}),e.jsx("h2",{className:"success-title",children:"Awesome!"}),e.jsxs("p",{className:"success-message",children:[g?"Subtask":"Task"," successfully added to your list"]}),e.jsx("button",{type:"button",className:"task-btn task-btn-primary task-btn-full",onClick:i,children:"Continue"})]})]})})]})}const ve=[{emoji:"ðŸ˜´",label:"Trivial",description:"5 mins or less"},{emoji:"ðŸ™‚",label:"Easy",description:"Simple, no blockers"},{emoji:"ðŸ˜¤",label:"Medium",description:"Needs focus"},{emoji:"ðŸ˜°",label:"Hard",description:"Complex, takes time"},{emoji:"ðŸ¤¯",label:"Nightmare",description:"Very challenging"}],ke=[{emoji:"ðŸ”¥",label:"On Fire",description:"Was in the zone"},{emoji:"ðŸ˜Ž",label:"Smooth",description:"No issues at all"},{emoji:"ðŸ˜µ",label:"Survived",description:"Hard but done"},{emoji:"ðŸ˜©",label:"Drained",description:"Energy-consuming"},{emoji:"ðŸŽ‰",label:"Exciting",description:"Loved every bit"}];function Ne({label:j,options:s,selected:t,onSelect:i}){const[o,l]=Ye.useState(!1),h=s.find(p=>p.emoji===t);return e.jsxs("div",{className:"emoji-accordion-row",children:[e.jsxs("button",{className:"emoji-accordion-header",onClick:p=>{p.stopPropagation(),l(w=>!w)},children:[e.jsxs("span",{className:"emoji-accordion-left",children:[e.jsx("span",{className:"emoji-accordion-icon",children:t??"â€”"}),e.jsxs("span",{className:"emoji-accordion-label",children:[j,h?`: ${h.label}`:""]})]}),e.jsx("span",{className:`emoji-accordion-chevron ${o?"open":""}`,children:"â–¾"})]}),o&&e.jsx("div",{className:"emoji-accordion-options",onClick:p=>p.stopPropagation(),children:s.map(p=>e.jsxs("button",{className:`dropdown-emoji-btn ${t===p.emoji?"active":""}`,"data-tip":p.label,onClick:w=>{w.stopPropagation(),i(t===p.emoji?null:p.emoji),l(!1)},children:[p.emoji,e.jsx("span",{className:"emoji-accordion-opt-label",children:p.label})]},p.emoji))})]})}function ne({taskId:j,currentDifficulty:s,currentMood:t,updateTaskEmoji:i,closeDropdown:o}){return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dropdown-divider"}),e.jsx("div",{className:"dropdown-section-title",children:"Rate This Task"}),e.jsx(Ne,{label:"Difficulty",options:ve,selected:s,onSelect:l=>i(j,"difficulty_emoji",l)}),e.jsx(Ne,{label:"Mood",options:ke,selected:t,onSelect:l=>i(j,"completion_mood",l)})]})}function we({difficulty:j,mood:s}){if(!j&&!s)return null;const t=ve.find(o=>o.emoji===j),i=ke.find(o=>o.emoji===s);return e.jsxs("span",{className:"task-emoji-badges",children:[j&&e.jsx("span",{className:"emoji-badge-chip",title:t?`Difficulty: ${t.label}`:"Difficulty",children:j}),s&&e.jsx("span",{className:"emoji-badge-chip",title:i?`Mood: ${i.label}`:"Mood",children:s})]})}function rs(j){const{filteredTasks:s,subtasks:t,loading:i,isMobileView:o,expandedTasks:l,openDropdownId:h,activeFilter:p,toggleTaskExpansion:w,toggleDropdown:b,closeDropdown:u,openModal:N,openEditModal:y,deleteTask:v,toggleTaskCompletion:F,updateTaskStatus:g,updateTaskEmoji:T,formatDueDate:_,getStatusIcon:P,getPriorityInfo:R}=j;return e.jsx("div",{className:"task-list-container",children:i?e.jsxs("div",{className:"loading-state",children:[e.jsx(G,{className:"animate-spin",size:24}),e.jsx("p",{children:"Loading tasks..."})]}):s.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx(W,{size:48,className:"text-slate-300"}),e.jsx("h3",{children:"No tasks found"}),e.jsx("p",{children:"Get started by creating your first task!"}),e.jsxs("button",{className:"empty-state-button",onClick:()=>N(),children:[e.jsx(Z,{size:20}),"Create Task"]})]}):e.jsx("div",{className:"tasks-list",children:s.map(n=>{const C=n.id?t[n.id]||[]:[],r=p==="all"?C:C.filter(m=>m.status===p),S=C.filter(m=>m.status==="done").length,k=r.length>0,M=n.id?l.has(n.id):!1,L=P(n.status),D=R(n.priority),H=L.icon;return e.jsxs("div",{className:"task-row-container",children:[e.jsxs("div",{className:"task-row",children:[e.jsx("button",{className:"expand-button",onClick:()=>n.id&&k&&w(n.id),disabled:!k,children:k?M?e.jsx(Qe,{size:16,className:"text-slate-500"}):e.jsx(Xe,{size:16,className:"text-slate-500"}):e.jsx("div",{className:"w-4 h-4"})}),e.jsxs("div",{className:"task-content",children:[e.jsx("div",{className:"task-title-row",children:e.jsxs("h3",{className:"task-title",children:[n.task_name,n.id&&C.length>0&&e.jsxs("span",{className:"subtask-pill",children:[S,"/",C.length]}),e.jsx(we,{difficulty:n.difficulty_emoji,mood:n.completion_mood})]})}),n.description&&e.jsx("p",{className:"task-description",children:n.description})]}),e.jsxs("div",{className:"status-badge",children:[e.jsx(H,{size:16,className:L.color}),e.jsx("span",{className:"status-text",children:n.status.replace("_"," ")})]}),e.jsxs("div",{className:"priority-badge",children:[e.jsx(pe,{size:16,className:D.color}),e.jsx("span",{className:`priority-text ${D.color}`,children:D.text})]}),e.jsxs("div",{className:"due-date",children:[e.jsx(he,{size:16,className:"text-slate-500"}),e.jsx("span",{className:"due-date-text",children:_(n.due_date)})]}),e.jsx("div",{className:"task-actions-dropdown",children:e.jsxs("div",{className:"relative-position",children:[e.jsx("button",{className:"more-actions-button",onClick:m=>{m.stopPropagation(),n.id&&b(n.id)},"aria-expanded":h===n.id,children:e.jsx(xe,{size:16,className:"text-slate-500"})}),h===n.id&&(o?e.jsxs("div",{children:[e.jsx("div",{className:"mobile-sheet-backdrop",onClick:u}),e.jsxs("div",{className:"mobile-sheet",role:"dialog","aria-modal":"true",onClick:m=>m.stopPropagation(),children:[e.jsx("div",{className:"mobile-sheet-header",children:e.jsx("button",{className:"mobile-sheet-close",onClick:u,"aria-label":"Close",children:"Ã—"})}),e.jsxs("div",{className:"mobile-sheet-content",children:[e.jsx("div",{className:"dropdown-section-title",children:"Change Status"}),n.status!=="todo"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),n.id&&g(n.id,"todo")},children:[e.jsx(W,{size:16,className:"text-slate-400"}),e.jsx("span",{children:"Mark as To Do"})]}),n.status!=="in_progress"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),n.id&&g(n.id,"in_progress")},children:[e.jsx(G,{size:16,className:"text-blue-500"}),e.jsx("span",{children:"Mark as In Progress"})]}),n.status!=="done"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),n.id&&g(n.id,"done")},children:[e.jsx(ee,{size:16,className:"text-emerald-500"}),e.jsx("span",{children:"Mark as Done"})]}),n.id&&e.jsx(ne,{taskId:n.id,currentDifficulty:n.difficulty_emoji,currentMood:n.completion_mood,updateTaskEmoji:T,closeDropdown:u}),e.jsx("div",{className:"dropdown-divider"}),(n.parent_id===null||n.parent_id===void 0)&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),n.id&&N(n.id)},children:[e.jsx(Z,{size:16}),e.jsx("span",{children:"Add Subtask"})]}),e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),y(n)},children:[e.jsx(te,{size:16}),e.jsx("span",{children:"Edit Task"})]}),e.jsxs("div",{className:"dropdown-item delete",onClick:()=>{u(),n.id&&v(n.id)},children:[e.jsx(ae,{size:16}),e.jsx("span",{children:"Delete Task"})]})]})]})]}):e.jsxs("div",{className:"dropdown-menu",onClick:m=>m.stopPropagation(),children:[e.jsx("div",{className:"dropdown-section-title",children:"Change Status"}),n.status!=="todo"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),n.id&&g(n.id,"todo")},children:[e.jsx(W,{size:14,className:"text-slate-400"}),e.jsx("span",{children:"Mark as To Do"})]}),n.status!=="in_progress"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),n.id&&g(n.id,"in_progress")},children:[e.jsx(G,{size:14,className:"text-blue-500"}),e.jsx("span",{children:"Mark as In Progress"})]}),n.status!=="done"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),n.id&&g(n.id,"done")},children:[e.jsx(ee,{size:14,className:"text-emerald-500"}),e.jsx("span",{children:"Mark as Done"})]}),n.id&&e.jsx(ne,{taskId:n.id,currentDifficulty:n.difficulty_emoji,currentMood:n.completion_mood,updateTaskEmoji:T,closeDropdown:u}),e.jsx("div",{className:"dropdown-divider"}),(n.parent_id===null||n.parent_id===void 0)&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),n.id&&N(n.id)},children:[e.jsx(Z,{size:14}),e.jsx("span",{children:"Add Subtask"})]}),e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),y(n)},children:[e.jsx(te,{size:14}),e.jsx("span",{children:"Edit Task"})]}),e.jsxs("div",{className:"dropdown-item delete",onClick:()=>{u(),n.id&&v(n.id)},children:[e.jsx(ae,{size:14}),e.jsx("span",{children:"Delete Task"})]})]}))]})})]}),k&&M&&e.jsxs("div",{className:"subtasks-container",children:[e.jsx("div",{className:"connector-line"}),r.map(m=>{const Q=P(m.status),U=R(m.priority),I=Q.icon;return e.jsxs("div",{className:"subtask-row",children:[e.jsx("div",{className:"horizontal-connector"}),e.jsxs("div",{className:"subtask-card",children:[e.jsx("div",{className:"expand-button-placeholder"}),e.jsxs("div",{className:"task-content",children:[e.jsx("div",{className:"task-title-row",children:e.jsxs("h4",{className:"subtask-title",children:[m.task_name,e.jsx(we,{difficulty:m.difficulty_emoji,mood:m.completion_mood})]})}),m.description&&e.jsx("p",{className:"task-description",children:m.description})]}),e.jsxs("div",{className:"status-badge",children:[e.jsx(I,{size:16,className:Q.color}),e.jsx("span",{className:"status-text",children:m.status.replace("_"," ")})]}),e.jsxs("div",{className:"priority-badge",children:[e.jsx(pe,{size:16,className:U.color}),e.jsx("span",{className:`priority-text ${U.color}`,children:U.text})]}),e.jsxs("div",{className:"due-date",children:[e.jsx(he,{size:16,className:"text-slate-500"}),e.jsx("span",{className:"due-date-text",children:_(m.due_date)})]}),e.jsx("div",{className:"task-actions-dropdown",children:e.jsxs("div",{className:"relative-position",children:[e.jsx("button",{className:"more-actions-button",onClick:E=>{E.stopPropagation(),m.id&&b(m.id)},"aria-expanded":h===m.id,children:e.jsx(xe,{size:16,className:"text-slate-500"})}),h===m.id&&e.jsxs("div",{className:"dropdown-menu",onClick:E=>E.stopPropagation(),children:[e.jsx("div",{className:"dropdown-section-title",children:"Change Status"}),m.status!=="todo"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),m.id&&g(m.id,"todo")},children:[e.jsx(W,{size:14,className:"text-slate-400"}),e.jsx("span",{children:"Mark as To Do"})]}),m.status!=="in_progress"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),m.id&&g(m.id,"in_progress")},children:[e.jsx(G,{size:14,className:"text-blue-500"}),e.jsx("span",{children:"Mark as In Progress"})]}),m.status!=="done"&&e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),m.id&&g(m.id,"done")},children:[e.jsx(ee,{size:14,className:"text-emerald-500"}),e.jsx("span",{children:"Mark as Done"})]}),m.id&&e.jsx(ne,{taskId:m.id,currentDifficulty:m.difficulty_emoji,currentMood:m.completion_mood,updateTaskEmoji:T,closeDropdown:u}),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("div",{className:"dropdown-item",onClick:()=>{u(),y(m)},children:[e.jsx(te,{size:14}),e.jsx("span",{children:"Edit Task"})]}),e.jsxs("div",{className:"dropdown-item delete",onClick:()=>{u(),m.id&&v(m.id)},children:[e.jsx(ae,{size:14}),e.jsx("span",{children:"Delete Task"})]})]})]})})]})]},m.id)})]})]},n.id)})})})}class cs{constructor(){this.ref=es(O,"tasks")}getCurrentUid(){return fe.currentUser?fe.currentUser.uid:null}async getAllTasks(){const s=this.getCurrentUid();if(!s)return[];const t=ie(this.ref,B("owner_uid","==",s));return(await oe(t)).docs.map(o=>({id:o.id,...o.data()}))}async getMainTasks(){const s=this.getCurrentUid();if(!s)return[];const t=ie(this.ref,B("owner_uid","==",s),B("parent_id","==",null));return(await oe(t)).docs.map(l=>({id:l.id,...l.data()}))}async getSubTasks(s){const t=this.getCurrentUid();if(!t)return[];const i=ie(this.ref,B("owner_uid","==",t),B("parent_id","==",s));return(await oe(i)).docs.map(l=>({id:l.id,...l.data()}))}async getTaskById(s){const t=J(O,"tasks",s),i=await K(t);if(!i.exists())return null;const o=i.data(),l=this.getCurrentUid();return!l||o.owner_uid&&o.owner_uid!==l?null:{id:i.id,...o}}async createTask(s){if(s.priority<1||s.priority>4)throw new Error("Priority must be between 1 and 4");if(!s.task_name||s.task_name.trim()==="")throw new Error("Task name is required");const t=q.now(),i=this.getCurrentUid();if(!i)throw new Error("Not authenticated");await ss(this.ref,{task_name:s.task_name,description:s.description??null,parent_id:s.parent_id??null,status:s.status??"todo",priority:s.priority,due_date:s.due_date?q.fromDate(s.due_date):null,attachments:s.attachments??null,difficulty_emoji:s.difficulty_emoji??null,completion_mood:s.completion_mood??null,created_at:t,updated_at:t,completed_at:s.status==="done"?t:null,owner_uid:i})}async updateStatus(s,t){if(!["todo","in_progress","blocked","done"].includes(t))throw new Error("Invalid status value");const i=q.now(),o=J(O,"tasks",s),l=await K(o),h=this.getCurrentUid();if(!h)throw new Error("Not authenticated");const p=l.exists()?l.data():null;if(!p||p.owner_uid&&p.owner_uid!==h)throw new Error("Unauthorized");await je(o,{status:t,updated_at:i,completed_at:t==="done"?i:null})}async updateTask(s,t){const i=q.now(),o=J(O,"tasks",s),l={...t,updated_at:i};t.due_date&&(l.due_date=q.fromDate(t.due_date));const h=["difficulty_emoji","completion_mood"];Object.keys(l).forEach(u=>{l[u]===void 0&&!h.includes(u)&&delete l[u]});const p=await K(o),w=this.getCurrentUid();if(!w)throw new Error("Not authenticated");const b=p.exists()?p.data():null;if(!b||b.owner_uid&&b.owner_uid!==w)throw new Error("Unauthorized");await je(o,l)}async deleteTask(s){const t=J(O,"tasks",s),i=await K(t),o=this.getCurrentUid();if(!o)throw new Error("Not authenticated");const l=i.exists()?i.data():null;if(!l||l.owner_uid&&l.owner_uid!==o)throw new Error("Unauthorized");await ts(t)}}class ds{constructor(s,t){this.taskRepository=s,this.fileUploadService=t}async completeTask(s){await this.taskRepository.updateStatus(s,"done")}async reopenTask(s){await this.taskRepository.updateStatus(s,"todo")}async updateStatus(s,t){await this.taskRepository.updateStatus(s,t)}async deleteTask(s){try{const t=await this.taskRepository.getTaskById(s);if(t&&t.attachments&&this.fileUploadService)for(const i of t.attachments)try{await this.fileUploadService.deleteFile(i.fileUrl)}catch(o){console.error("Failed to delete attachment for task:",i.fileUrl,o)}try{const i=await this.taskRepository.getSubTasks(s);for(const o of i){if(o&&o.attachments&&this.fileUploadService)for(const l of o.attachments)try{await this.fileUploadService.deleteFile(l.fileUrl)}catch(h){console.error("Failed to delete attachment for subtask:",l.fileUrl,h)}if(o.id)try{await this.taskRepository.deleteTask(o.id)}catch(l){console.error("Failed to delete subtask doc:",o.id,l)}}}catch(i){console.error("Failed to fetch subtasks for deletion:",i)}await this.taskRepository.deleteTask(s)}catch(t){throw console.error("Error deleting task:",t),t}}async uploadTaskFiles(s){if(!this.fileUploadService)throw new Error("FileUploadService is not configured");try{console.log(`[TaskService] Starting file upload for ${s.length} file(s)`);const t=await this.fileUploadService.uploadMultipleFiles(s);return console.log(`[TaskService] File upload successful, got ${t.length} results`),t.map((i,o)=>({id:`attachment_${Date.now()}_${o}`,fileName:i.fileName,fileUrl:i.fileUrl,fileType:i.fileType,uploadedAt:i.uploadedAt}))}catch(t){throw console.error("Error uploading task files:",t),t}}async removeTaskAttachment(s,t,i){try{this.fileUploadService&&await this.fileUploadService.deleteFile(i.fileUrl);const o=await this.taskRepository.getTaskById(s);if(!o)throw new Error("Task not found");const l=o.attachments?.filter(h=>h.id!==t);await this.taskRepository.updateTask(s,{attachments:l})}catch(o){throw console.error("Error removing task attachment:",o),o}}isImageFile(s){if(!this.fileUploadService){const t=["jpg","jpeg","png","gif","webp"],i=s.name.split(".").pop()?.toLowerCase()||"";return s.type.startsWith("image/")||t.includes(i)}return this.fileUploadService.isImageFile(s)}}class ms{constructor(){this.storage=as(),this.allowedImageMimeTypes=["image/jpeg","image/jpg","image/png","image/gif","image/webp","image/svg+xml","image/bmp","image/x-icon","image/tiff","image/avif"],this.imageExtensions=["jpg","jpeg","png","gif","webp","svg","bmp","ico","tiff","tif","avif"],this.blockedExtensions=["exe","bat","cmd","com","pif","scr","vbs","js","jar","zip","rar","7z"],this.blockedMimeTypes=["application/x-msdownload","application/x-msdos-program","application/x-executable"],this.maxImageSize=5*1024*1024,this.maxAttachmentSize=25*1024*1024,this.maxTotalUploadSize=100*1024*1024}validateFileType(s){const i=s.name.toLowerCase().split(".").pop()||"",o=s.type.toLowerCase();return this.blockedExtensions.includes(i)?{fileName:s.name,reason:`File type "${i}" is not allowed for security reasons`}:this.blockedMimeTypes.some(l=>o.includes(l))?{fileName:s.name,reason:`File MIME type "${o}" is not allowed for security reasons`}:i?null:{fileName:s.name,reason:"File must have a valid extension"}}isImageFile(s){const t=s.type.toLowerCase(),o=s.name.toLowerCase().split(".").pop()||"";return this.allowedImageMimeTypes.includes(t)?!0:this.imageExtensions.includes(o)}getUploadPath(s){return this.isImageFile(s)?"images":"files"}validateFile(s,t=!1){const i=this.validateFileType(s);if(i)return i;const o=t?this.maxImageSize:this.maxAttachmentSize;if(s.size===0)return{fileName:s.name,reason:"File is empty"};if(s.size>o){const l=t?5:25;return{fileName:s.name,reason:`File exceeds ${l}MB size limit (${(s.size/1024/1024).toFixed(2)}MB)`}}return null}validateFilesBatch(s){const t=[];let i=0;for(const o of s){const l=this.isImageFile(o),h=this.validateFile(o,l);h&&t.push(h),i+=o.size}return i>this.maxTotalUploadSize&&t.push({fileName:"Multiple files",reason:`Total upload size exceeds 100MB limit (${(i/1024/1024).toFixed(2)}MB)`}),t}generateUniqueFileName(s){const t=Date.now(),i=Math.random().toString(36).substring(2,9),o=s.name.split(".").pop()||"";return`${(s.name.substring(0,s.name.lastIndexOf("."))||s.name).replace(/[^a-z0-9_-]/gi,"").substring(0,30)}_${t}_${i}.${o}`}async uploadFile(s){try{const t=this.isImageFile(s);console.log(`[FileUploadService] Uploading: ${s.name} (${t?"Image":"File"}) - Size: ${(s.size/1024/1024).toFixed(2)}MB`);const i=this.validateFile(s,t);if(i)throw console.error(`[FileUploadService] Validation failed for ${s.name}: ${i.reason}`),new Error(i.reason);const o=this.getUploadPath(s),l=this.generateUniqueFileName(s),h=`attachements/${o}/${l}`;console.log(`[FileUploadService] Storage path: ${h}`);const p=ge(this.storage,h);console.log("[FileUploadService] Starting upload to Firebase..."),await is(p,s),console.log(`[FileUploadService] Upload complete for ${s.name}`),console.log("[FileUploadService] Getting download URL...");const w=await os(p);return console.log("[FileUploadService] Got download URL"),{fileName:s.name,fileUrl:w,fileType:s.type,uploadPath:o,uploadedAt:new Date}}catch(t){throw console.error("Error uploading file:",t),new Error(`Failed to upload ${s.name}: ${t.message}`)}}async uploadMultipleFiles(s){try{console.log(`[FileUploadService] Starting batch upload of ${s.length} file(s)`);const t=this.validateFilesBatch(s);if(t.length>0){const o=t.map(l=>`${l.fileName}: ${l.reason}`).join(`
`);throw console.error(`[FileUploadService] Validation errors: ${o}`),new Error(`File validation failed:
${o}`)}const i=[];for(const o of s){const l=await this.uploadFile(o);i.push(l)}return console.log(`[FileUploadService] Batch upload complete: ${i.length} file(s) uploaded`),i}catch(t){throw console.error("Error uploading multiple files:",t),t}}async deleteFile(s){try{const t=s.split("/o/")[1];if(!t)throw new Error("Invalid file URL");const i=decodeURIComponent(t.split("?")[0]),o=ge(this.storage,i);await ns(o)}catch(t){throw console.error("Error deleting file:",t),new Error(`Failed to delete file: ${t.message}`)}}}const z=new cs,ye=new ms,V=new ds(z,ye);function js(){const[j,s]=f.useState([]),[t,i]=f.useState({}),[o,l]=f.useState(!0),[h,p]=f.useState(!1),[w,b]=f.useState(!1),[u,N]=f.useState(!1),[y,v]=f.useState(null),[F,g]=f.useState("all"),[T,_]=f.useState(""),[P,R]=f.useState(new Set),[n,C]=f.useState(null),[r,S]=f.useState(null),[k,M]=f.useState({task_name:"",description:"",priority:3,status:"todo",due_date:""}),[L,D]=f.useState(null),[H,m]=f.useState(null),[Q,U]=f.useState(!1),[I,E]=f.useState([]),[X,A]=f.useState([]),[be,Y]=f.useState(!1),[Se,Te]=f.useState(!1),_e=f.useMemo(()=>{const a={all:j.length,todo:0,in_progress:0,done:0};for(const d of j){const c=d.id?t[d.id]||[]:[];c.some(x=>x.status==="todo")&&(a.todo+=1),c.some(x=>x.status==="in_progress")&&(a.in_progress+=1),c.some(x=>x.status==="done")&&(a.done+=1)}return a},[j,t]);f.useEffect(()=>{$()},[]),f.useEffect(()=>{const a=()=>Te(window.innerWidth<=490);return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);async function $(){try{l(!0),console.log("Loading tasks from Firestore...");const a=await z.getMainTasks();console.log("Main tasks loaded:",a),s(a);const d={};for(const c of a)if(c.id){const x=await z.getSubTasks(c.id);d[c.id]=x}i(d)}catch(a){console.error("Error loading tasks:",a),alert("Error loading tasks: "+a.message)}finally{l(!1)}}async function Ce(a,d=!1){try{const c=d?Object.values(t).flat().find(se=>se.id===a):j.find(se=>se.id===a);if(!c)return;const x=c.status==="done"?"todo":"done";x==="done"?await V.completeTask(a):await z.updateStatus(a,x),await $()}catch(c){console.error("Error updating task:",c),alert("Error updating task: "+c.message)}}async function Ee(a,d){try{await V.updateStatus(a,d),await $()}catch(c){console.error("Error updating task status:",c),alert("Error updating task status: "+c.message)}}async function Fe(a,d,c){try{await z.updateTask(a,{[d]:c}),await $()}catch(x){console.error("Error updating emoji:",x),alert("Error updating emoji: "+x.message)}}async function De(a){try{await V.deleteTask(a),await $()}catch(d){console.error("Error deleting task:",d),alert("Error deleting task: "+d.message)}}function le(a){M({task_name:"",description:"",priority:3,status:"todo",due_date:""}),U(!1),S(null),E([]),A([]),D(null),m(null),a?(N(!0),v(a)):(N(!1),v(null)),p(!0)}function re(){p(!1),U(!1),N(!1),v(null),S(null),E([]),A([]),D(null),m(null)}function Ue(a){M({task_name:a.task_name||"",description:a.description||"",priority:a.priority||2,status:a.status||"todo",due_date:a.due_date?a.due_date.seconds?new Date(a.due_date.seconds*1e3).toISOString().slice(0,10):new Date(a.due_date).toISOString().slice(0,10):""}),S(a.id||null),N(a.parent_id!==null&&a.parent_id!==void 0),v(a.parent_id??null),A(a.attachments||[]),E([]),D(a.difficulty_emoji??null),m(a.completion_mood??null),p(!0)}function ze(){b(!1)}function Me(a){const{name:d,value:c}=a.target;M(x=>({...x,[d]:c}))}function Ie(a){const d=a.target.files;if(d){const c=Array.from(d);E(x=>[...x,...c])}}function $e(a){E(d=>d.filter((c,x)=>x!==a))}async function Pe(a){const d=X.find(c=>c.id===a);if(r&&d)try{Y(!0),await V.removeTaskAttachment(r,a,d),A(c=>c.filter(x=>x.id!==a))}catch(c){console.error("Error removing attachment:",c),alert("Failed to remove attachment: "+c.message)}finally{Y(!1)}else A(c=>c.filter(x=>x.id!==a))}function Re(a){return["image/jpeg","image/png","image/gif","image/webp","image/svg+xml"].includes(a.fileType.toLowerCase())}function Le(a){R(d=>{const c=new Set(d);return c.has(a)?c.delete(a):c.add(a),c})}function Ae(a){C(d=>d===a?null:a)}function ce(){C(null)}f.useEffect(()=>{function a(){ce()}return document.addEventListener("click",a),()=>document.removeEventListener("click",a)},[]);function Oe(){let a=j;if(F!=="all"&&(a=a.filter(d=>(d.id?t[d.id]||[]:[]).some(x=>x.status===F))),T.trim()){const d=T.toLowerCase();a=a.filter(c=>c.task_name.toLowerCase().includes(d)||c.description&&c.description.toLowerCase().includes(d))}return a}function Be(a){switch(a){case"todo":return{icon:W,color:"text-slate-400"};case"in_progress":return{icon:G,color:"text-blue-500"};case"done":return{icon:ee,color:"text-emerald-500"};default:return{icon:Ke,color:"text-red-500"}}}function qe(a){switch(a){case 1:return{color:"text-slate-400",text:"P4"};case 2:return{color:"text-blue-500",text:"P3"};case 3:return{color:"text-orange-500",text:"P2"};case 4:return{color:"text-red-500",text:"P1"};default:return{color:"text-slate-400",text:"P4"}}}function Ve(a){if(!a)return"No date";const d=a;return(d.seconds?new Date(d.seconds*1e3):new Date(a)).toLocaleDateString("en-US",{month:"short",day:"numeric"})}async function Ge(a){if(a&&a.preventDefault&&a.preventDefault(),U(!0),!(!k.task_name||k.task_name.trim()===""))try{Y(!0);let d=[...X];if(I.length>0){console.log(`[task.tsx] Uploading ${I.length} new file(s)`);const x=await V.uploadTaskFiles(I);console.log(`[task.tsx] Got ${x.length} attachment(s) with URLs`),d=[...X,...x]}const c={task_name:k.task_name.trim(),description:k.description.trim()||void 0,status:k.status,priority:Number(k.priority),due_date:k.due_date?new Date(k.due_date):void 0,parent_id:u&&y?y:void 0,attachments:d.length>0?d:void 0,difficulty_emoji:L??null,completion_mood:H??null};console.log("Submitting task:",c),console.log(`[task.tsx] Task has ${d.length} attachment(s)`),r?(await z.updateTask(r,c),console.log("Task updated successfully!")):(await z.createTask(c),console.log("Task created successfully!")),await $(),console.log("Tasks reloaded"),U(!1),re(),b(!0)}catch(d){console.error("Error adding task from modal:",d),alert("Failed to add task: "+d.message+`

Check console for details.`)}finally{Y(!1)}}const We=Oe();return e.jsxs(Ze,{id:"task",children:[e.jsxs("div",{className:"task-header-section",children:[e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("h1",{className:"header-title",children:"Tasks"}),e.jsx("p",{className:"header-subtitle",children:"Manage your tasks effectively with Taskly"})]}),e.jsxs("div",{className:"header-right",children:[e.jsxs("div",{className:"search-container",children:[e.jsx(Je,{className:"search-icon",size:20}),e.jsx("input",{type:"text",placeholder:"Search tasks...",className:"search-input",value:T,onChange:a=>_(a.target.value)})]}),e.jsxs("button",{className:"new-task-button",onClick:()=>le(),children:[e.jsx(Z,{size:20}),"New Task"]})]})]}),e.jsx("div",{className:"filter-tabs",children:[{key:"all",label:"All Tasks"},{key:"todo",label:"To Do"},{key:"in_progress",label:"In Progress"},{key:"done",label:"Done"}].map(a=>e.jsxs("button",{className:`filter-tab ${F===a.key?"active":""}`,onClick:()=>g(a.key),children:[a.label," ","("+(_e[a.key]??0)+")"]},a.key))})]}),e.jsx(rs,{filteredTasks:We,subtasks:t,loading:o,isMobileView:Se,expandedTasks:P,openDropdownId:n,activeFilter:F,toggleTaskExpansion:Le,toggleDropdown:Ae,closeDropdown:ce,openModal:le,openEditModal:Ue,deleteTask:De,toggleTaskCompletion:Ce,updateTaskStatus:Ee,updateTaskEmoji:Fe,formatDueDate:Ve,getStatusIcon:Be,getPriorityInfo:qe}),e.jsx(ls,{isOpen:h,showSuccess:w,onClose:re,onCloseSuccess:ze,onSubmit:Ge,form:k,handleFormChange:Me,handleFileSelect:Ie,removeFile:$e,removeAttachment:Pe,isImageAttachment:Re,uploadedFiles:I,attachments:X,uploading:be,editingTaskId:r,isSubtaskMode:u,showValidationErrors:Q,fileUploadService:ye,difficultyEmoji:L,completionMood:H,onDifficultyChange:D,onMoodChange:m})]})}export{js as default};
